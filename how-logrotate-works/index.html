
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>logrotate机制和原理 - 0xFEE1C001</title>
  <meta name="author" content="Light Xue">

  <!---->
  
  <meta name="description" content="0xFEE1C001, Light Xue's blog">
  <!---->
  <meta name="keywords" content="c, c++, python, linux, network, program, lightxue, Light Xue, develop, algorithm, fee1c001, '0xfee1c001', feelcool">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.lightxue.com/how-logrotate-works">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="0xFEE1C001" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">-->
<!--<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">-->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">0xFEE1C001</a></h1>
  
    <h2>Where there is a shell, there is a way</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.lightxue.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">logrotate机制和原理</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-23T02:09:49+08:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>日志实在是太有用了，它记录了程序运行时各种信息。通过日志可以分析用户行为，记录运行轨迹，查找程序问题。可惜磁盘的空间是有限的，就像飞机里的黑匣子，记录的信息再重要也只能记录最后一段时间发生的事。为了节省空间和整理方便，日志文件经常需要按时间或大小等维度分成多份，删除时间久远的日志文件。这就是通常说的日志滚动(log rotation)。</p>

<p>最近整理nginx日志，用了一个类Unix系统上的古老工具——logrotate，发现意外的好用。想了解这个工具的用法推荐看<a href="http://www.thegeekstuff.com/2010/07/logrotate-examples/">这里</a>。我了解了一下这个工具的运行机制和原理，觉得挺有趣的。</p>

<!--more-->


<h2>运行机制</h2>

<p>logrotate在很多Linux发行版上都是默认安装的。系统会定时运行logrotate，一般是每天一次。系统是这么实现按天执行的。crontab会每天定时执行<code>/etc/cron.daily</code>目录下的脚本，而这个目录下有个文件叫<code>logrotate</code>。在centos上脚本内容是这样的：</p>

<figure class='code'><figcaption><span>/etc/cron.daily/logrotate</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;1
</span><span class='line'><span class="nv">EXITVALUE</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$EXITVALUE</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>    /usr/bin/logger -t logrotate <span class="s2">&quot;ALERT exited abnormally with [$EXITVALUE]&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<p>可以看到这个脚本主要做的事就是以<code>/etc/logrotate.conf</code>为配置文件执行了logrotate。就是这样实现了每天执行一次logrotate。</p>

<p>因为我的系统执行<code>/etc/cron.daily</code>目录下的脚本不是我想滚动日志的时间，所以我把<code>/etc/cron.daily/logrotate</code>拷了出来，改了一下logrotate配置文件的路径，然后在crontab里加上一条指定时间执行这个脚本的记录，自定义周期滚动日志就大功告成了。这种自定义的方式有两点要注意：</p>

<ol>
<li><p>配置文件里一定要配置<code>rotate 文件数目</code>这个参数。如果不配置默认是0个，也就是只允许存在一份日志，刚切分出来的日志会马上被删除。多么痛的领悟，说多了都是泪。</p></li>
<li><p>执行logrotate命令最好加<code>-f</code>参数，不然有时候配置文件修改的内容不生效。</p></li>
</ol>


<p>很多程序的会用到logrotate滚动日志，比如nginx。它们安装后，会在<code>/etc/logrotate.d</code>这个目录下增加自己的logrotate的配置文件。logrotate什么时候执行<code>/etc/logrotate.d</code>下的配置呢？看到<code>/etc/logrotate.conf</code>里这行，一切就不言而喻了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">logrotate</span><span class="p">.</span><span class="n">d</span>
</span></code></pre></td></tr></table></div></figure>


<h2>原理</h2>

<p>logrotate是怎么做到滚动日志时不影响程序正常的日志输出呢？logrotate提供了两种解决方案。</p>

<h3>Linux文件操作机制</h3>

<p>介绍一下相关的Linux下的文件操作机制。</p>

<p>Linux文件系统里文件和文件名的关系如下图。</p>

<p><img src="/images/how-logrotate-works/inodes.png" alt="" /></p>

<p>目录也是文件，文件里存着文件名和对应的inode编号。通过这个inode编号可以查到文件的元数据和文件内容。文件的元数据有引用计数、操作权限、拥有者ID、创建时间、最后修改时间等等。文件件名并不在元数据里而是在目录文件中。因此文件改名、移动，都不会修改文件，而是修改目录文件。</p>

<p>借《UNIX环境高级编程》里的图说一下进程打开文件的机制。</p>

<p><img src="/images/how-logrotate-works/file_pointer.gif" alt="" /></p>

<p>进程每新打开一个文件，系统会分配一个新的文件描述符给这个文件。文件描述符对应着一个文件表。表里面存着文件的状态信息（<code>O_APPEND</code>/<code>O_CREAT</code>/<code>O_DIRECT</code>&hellip;）、当前文件位置和文件的inode信息。系统会为每个进程创建独立的文件描述符和文件表，不同进程是不会共用同一个文件表。正因为如此，不同进程可以同时用不同的状态操作同一个文件的不同位置。文件表中存的是inode信息而不是文件路径，所以文件路径发生改变不会影响文件操作。</p>

<h3>方案1：create</h3>

<p>默认方案没有名字，姑且叫它create吧。因为这个方案会创建一个新的日志文件给程序输出日志，而且第二个方案名copytruncate是个配置项，与create配置项是互斥的。</p>

<p>这个方案的思路是重命名原日志文件，创建新的日志文件。详细步骤如下：</p>

<ol>
<li><p>重命名程序当前正在输出日志的程序。因为重命名只会修改目录文件的内容，而进程操作文件靠的是inode编号，所以并不影响程序继续输出日志。</p></li>
<li><p>创建新的日志文件，文件名和原来日志文件一样。虽然新的日志文件和原来日志文件的名字一样，但是inode编号不一样，所以程序输出的日志还是往原日志文件输出。</p></li>
<li><p>通过某些方式通知程序，重新打开日志文件。程序重新打开日志文件，靠的是文件路径而不是inode编号，所以打开的是新的日志文件。</p></li>
</ol>


<p>什么方式通知程序我重新打开日志呢，简单粗暴的方法是杀死进程重新打开。很多场景这种作法会影响在线的服务，于是有些程序提供了重新打开日志的接口，比如可以通过信号通知nginx。各种IPC方式都可以，前提是程序自身要支持这个功能。</p>

<p>有个地方值得一提，一个程序可能输出了多个需要滚动的日志文件。每滚动一个就通知程序重新打开所有日志文件不太划得来。有个<code>sharedscripts</code>的参数，让程序把所有日志都重命名了以后，只通知一次。</p>

<h3>方案2：copytruncate</h3>

<p>如果程序不支持重新打开日志的功能，又不能粗暴地重启程序，怎么滚动日志呢？copytruncate的方案出场了。</p>

<p>这个方案的思路是把正在输出的日志拷(copy)一份出来，再清空(trucate)原来的日志。详细步骤如下：</p>

<ol>
<li><p>拷贝程序当前正在输出的日志文件，保存文件名为滚动结果文件名。这期间程序照常输出日志到原来的文件中，原来的文件名也没有变。</p></li>
<li><p>清空程序正在输出的日志文件。清空后程序输出的日志还是输出到这个日志文件中，因为清空文件只是把文件的内容删除了，文件的inode编号并没有发生变化，变化的是元信息中文件内容的信息。</p></li>
</ol>


<p>结果上看，旧的日志内容存在滚动的文件里，新的日志输出到空的文件里。实现了日志的滚动。</p>

<p>这个方案有两个有趣的地方。</p>

<ol>
<li><p>文件清空并不影响到输出日志的程序的文件表里的文件位置信息，因为各进程的文件表是独立的。那么文件清空后，程序输出的日志应该接着之前日志的偏移位置输出，这个位置之前会被<code>\0</code>填充才对。但实际上logroate清空日志文件后，程序输出的日志都是从文件开始处开始写的。这是怎么做到的？这个问题让我纠结了很久，直到某天灵光一闪，这不是logrotate做的，而是成熟的写日志的方式，都是用<code>O_APPEND</code>的方式写的。如果程序没有用<code>O_APPEND</code>方式打开日志文件，变会出现copytruncate后日志文件前面会被一堆<code>\0</code>填充的情况。</p></li>
<li><p>日志在拷贝完到清空文件这段时间内，程序输出的日志没有备份就清空了，这些日志不是丢了吗？是的，copytruncate有丢失部分日志内容的风险。所以能用create的方案就别用copytruncate。所以很多程序提供了通知我更新打开日志文件的功能来支持create方案，或者自己做了日志滚动，不依赖logrotate。</p></li>
</ol>


<h2>总结</h2>

<p>logrotate是个优秀的日志滚动工具，它是用蜂蜜，川贝，桔梗，加上天山雪莲配制而成，不须冷藏，也没有防腐剂，除了毒性猛烈之外，味道还很好吃。实在是居家旅行、杀人灭口必备良药！</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Light Xue</span></span>

      








  


<time datetime="2015-07-23T02:09:49+08:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/linux/'>Linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/as-a-foreigner-what-do-you-think-about-chinese-people" title="Previous Post: [翻译]作为一个外国人，你对中国人怎么看？">&laquo; [翻译]作为一个外国人，你对中国人怎么看？</a>
      
      
        <a class="basic-alignment right" href="/python-internals-introductory" title="Next Post: Python源码寻宝记——挖坑不埋">Python源码寻宝记——挖坑不埋 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/python-internals-introductory">Python源码寻宝记——挖坑不埋</a>
      </li>
    
      <li class="post">
        <a href="/how-logrotate-works">logrotate机制和原理</a>
      </li>
    
      <li class="post">
        <a href="/as-a-foreigner-what-do-you-think-about-chinese-people">[翻译]作为一个外国人，你对中国人怎么看？</a>
      </li>
    
      <li class="post">
        <a href="/about-barriers">关于barrier</a>
      </li>
    
      <li class="post">
        <a href="/strlen-implementation">strlen的实现方法</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Light Xue
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = '0xfee1c00l';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.lightxue.com/how-logrotate-works';
        var disqus_url = 'http://blog.lightxue.com/how-logrotate-works';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
