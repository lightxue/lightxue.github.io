<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="zh"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Python源码寻宝记——地图篇 &mdash; 0xFEE1C001</title>
  <meta name="author" content="Light Xue">
  <meta name="description" content="找到Python解释器特定逻辑的源码位置" />

  <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate"
        title="0xFEE1C001 Atom Feed" />





  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="/favicon.png" rel="icon">

  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">0xFEE1C001</a></h1>
    <h2>Where there is a shell, there is a way</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/feeds/atom.xml" rel="subscribe-atom">Atom</a></li>
</ul>


<ul class="main-navigation">
    <li><a href="/">首页</a></li>
    <li><a href="http://tools.lightxue.com">程序员工具</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Python源码寻宝记——地图篇</h1>
    <p class="meta">
<time datetime="2016-03-22T23:44:21+08:00" pubdate>2016-03-22</time>    </p>
</header>

  <div class="entry-content"><p>如果读源码的方式是打开源码包，一个个文件，一行行开始读。这种阅读源码方式太枯燥了。另一种方式，对Python的设计有了基本的了解后，找感兴趣的部分去阅读。兴致高，目的性强，内容少，阅读的过程会轻松有趣得多。</p>
<p>对Python设计基本了解包括对总体架构设计，对象系统实现原理，字节码的生成和解释过程有大致的了解。哪天闲得不行，可以写写这方面的文章。</p>
<p>感兴趣的部分源码怎么找？这个就是此文的主题了——如何找到特定逻辑的源码。</p>


<h2>下载源码</h2>
<p>Python官方给的下载源码的方式在<a href="https://docs.python.org/devguide/setup.html#getting-the-source-code">这里</a>。如果不想用Mercurial，也可以直接去<a href="https://www.python.org/downloads/">这里</a>下对应的版本的Gzipped source tarball。</p>
<h2>目录结构</h2>
<p>官方有源码目录的介绍，在<a href="https://docs.python.org/devguide/setup.html#directory-structure">这里</a>。重点说一下常见的目录。</p>
<ul>
<li>Grammar。EBNF描述的语法规则在这个目录下。</li>
<li>Include。整个解释器所有的头文件放在这个目录下。</li>
<li>Lib。纯Python实现的标准库。</li>
<li>Modules。C实现的标准库。</li>
<li>Objects。所有的内置类型的实现。</li>
<li>Python。Python虚拟机的核心代码。</li>
</ul>
<h2>源码定位</h2>
<p>感兴趣的地方不一样，定位的方式也不一样。介绍一下常见的几种。</p>
<h3>语法定义</h3>
<p>这个好说，去<code>Grammar</code>目录看语法规则吧。语法规则由Zephyr Abstract Syntax Definition Language定义，<a href="http://pages.cpsc.ucalgary.ca/~aycock/spark/">SPARK</a>解析的。</p>
<h3>内置对象</h3>
<p>找某个内置对象是怎么实现的，就直接去<code>Include</code>里看声明和<code>Object</code>看实现。</p>
<p>比如想知道<code>list.sort()</code>是怎么实现的。那么在<code>Include/listobject.h</code>里可以知道列表是怎么用<code>ob_item</code>表示数据的，在<code>Objects/listobject.c</code>的<code>list_methods</code>里看到了<code>sort()</code>是由<code>listsort()</code>实现的.<code>listsort()</code>的实现刚好也在<code>Objects/listobject.c</code>里。就这样找到了<code>list.sort()</code>的源码了。</p>
<h3>标准库</h3>
<p>想找标准库的实现，分两种情况。大部分情况，标准库是纯Python实现的。还有一小部分标准库是C实现的。</p>
<p>纯Python实现的标准库，可以不用直接去<code>Lib</code>下面找。Python内置了很好用的工具叫<code>inspect</code>。比如想知道<code>timeit.timeit()</code>的源码在哪，可以这么查。</p>
<div class="highlight"><pre><span></span><span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">inspect</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">timeit</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">)</span>
</pre></div>


<p><code>inspect</code>只对纯Python实现的库有效，拿C实现的标准库一点招没有。</p>
<p>C实现的标准库也有类似于<code>inspect</code>这种好用的方案，叫<a href="https://github.com/punchagan/cinspect">cinspect</a>，不过我没有尝试过。C的标准库不多，命名也比较容易懂。所以直接去<code>Modules</code>找一般很容易找到。</p>
<p>如果不想对着文件名猜某个模块是不是在这实现，就需要工具来帮忙了。这里推荐一下速度比<code>grep</code>快得多的<a href="http://beyondgrep.com/">ack</a>。举个例子，想找<code>time</code>的源码，可以执行这个命令。</p>
<div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> Modules
&gt; 
<span class="c1"># Python 2</span>
&gt; ack <span class="s1">&#39;Py_InitModule3\(&quot;time&quot;&#39;</span>
timemodule.c
<span class="m">854</span>:    <span class="nv">m</span> <span class="o">=</span> Py_InitModule3<span class="o">(</span><span class="s2">&quot;time&quot;</span>, time_methods, module_doc<span class="o">)</span><span class="p">;</span>

<span class="c1"># Python 3</span>
&gt; ack <span class="s1">&#39;PyModuleDef&#39;</span> -A <span class="m">5</span> <span class="p">|</span> ack <span class="s1">&#39;&quot;time&quot;&#39;</span>
timemodule.c-1331-    <span class="s2">&quot;time&quot;</span>,
</pre></div>


<p><code>Modules/timemodule.c</code>就是<code>time</code>模块实现的地方。<code>Py_InitModule3</code>是Python 2 注册模块的宏，<code>PyModuleDef</code>是Python 3 模块定义的结构体的名字。这两个地方都要填上模块名作参数向解释器注册模块。所以这么搜模块名，一搜一个准。</p>
<h3>语法实现</h3>
<p>想知道某个语法怎么实现的去哪找呢？这时候就要去解读字节码，找到对应语法的字节码，并去<code>ceval.c</code>看具体实现。</p>
<p>比如想看关键字<code>in</code>的实现，执行下面的代码可以看到<code>in</code>的字节码是<code>COMPARE_OP</code>。</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exp</span> <span class="o">=</span> <span class="s1">&#39;0 in (1, 2)&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
              <span class="mi">3</span> <span class="n">LOAD_CONST</span>               <span class="mi">3</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
              <span class="mi">6</span> <span class="n">COMPARE_OP</span>               <span class="mi">6</span> <span class="p">(</span><span class="ow">in</span><span class="p">)</span>
              <span class="mi">9</span> <span class="n">RETURN_VALUE</span>
</pre></div>


<p>具体各个字节码的意思可以去<a href="https://docs.python.org/2/library/dis.html#python-bytecode-instructions">这里</a>看解释。拿到了字节码后去<code>Python/ceval.c</code>里找<code>COMPARE_OP</code>的实现，会看到关键字<code>in</code>的实现在<code>PySequence_Contains</code>函数里。<code>ceval.c</code>里实现了字节码解析的eval loop，是整个源码中至关重要的部分。</p>
<h3>其它情况</h3>
<p>上面说的几种方法应该包含了大部分的情况，但也有些时候需要别的方法，比如找垃圾回收的实现。这里推荐一本深入剖析Python 2 源码的书，<a href="https://book.douban.com/subject/3117898/">《Python源码剖析》</a>。这本书详细介绍了Python源码里各个重要的地方，非常值得一看。</p>
<p>如果书里没有提到的地方，想快速定位源码位置，我的招式已经全部分用完了，剩下的只有问Google，问Stack Overflow，邮件大牛，或是自己去啃源码。</p>
<p>以上就是Python寻宝需要的地图。看这个系列更多文章，请到<a href="/python-internals-introductory">Python源码寻宝记——挖坑不埋篇</a>。</p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        <a href="/author/light-xue">Light Xue</a>
    </span>
  </span>
<time datetime="2016-03-22T23:44:21+08:00" pubdate>2016-03-22</time>  <!--<span class="categories">-->
    <!--<a class='category' href='/category/python'>Python</a>-->
  <!--</span>-->
  <!---->
  <!--<span class="categories">-->
    <!---->
    <!--<a class="category" href="/tag/python">Python</a>-->
    <!---->
  <!--</span>-->
  <!---->
</p><p class="meta">
本作品由<a xmlns:cc="http://creativecommons.org/ns#" target="_blank" href="http://www.lightxue.com" property="cc:attributionName" rel="cc:attributionURL">www.lightxue.com</a>采用<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/deed.zh">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可。
<p>
<div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>评论</h1>
    <div id="gitment-container"></div>
    <div id="gitment_thread" aria-live="polite"><noscript>请打开JavaScript查看评论</noscript>
</div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>最新文章</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/understand-python-decorator-the-easy-way">简单地理解Python的装饰器</a>
      </li>
      <li class="post">
          <a href="/transforming-code-into-beautiful-idiomatic-python">[译]让你的Python代码优雅又地道</a>
      </li>
      <li class="post">
          <a href="/python-internals-locate-source-code">Python源码寻宝记——地图篇</a>
      </li>
      <li class="post">
          <a href="/python-internals-introductory">Python源码寻宝记——挖坑不埋</a>
      </li>
      <li class="post">
          <a href="/edm-practices-notes">邮件发送实践经验</a>
      </li>
    </ul>
  </section>
  <section>

    <h1>分类</h1>
    <ul id="recent_posts">
        <li><a href="/category/c">C</a></li>
        <li><a href="/category/linux">Linux</a></li>
        <li><a href="/category/misc">Misc</a></li>
        <li><a href="/category/python">Python</a></li>
    </ul>
  </section>

  <!--<section>-->
  <!--<h1>Tags</h1>-->
  <!---->
    <!--<a href="/tag/python">Python</a>,-->
  <!---->
    <!--<a href="/tag/linux">Linux</a>,-->
  <!---->
    <!--<a href="/tag/shell">shell</a>,-->
  <!---->
    <!--<a href="/tag/c">C</a>,-->
  <!---->
    <!--<a href="/tag/algorithm">algorithm</a>-->
  <!---->
  <!--</section>-->



</aside>    </div>
  </div>
  <footer role="contentinfo">    Copyright &copy;  2013&ndash;2017  Light Xue &mdash;
  <span class="credit">Powered by <a target="_blank" href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42436465-3']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-42436465-3');
    ga('send', 'pageview');
    </script>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8a9edae11717cd734925510200712026";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  id: location.pathname,
  owner: 'lightxue',
  repo: 'lightxue.github.io',
  oauth: {
    client_id: 'cfbdea1160f74d535db2',
    client_secret: '5616e795360075c1d526671e6b272f3da57ac501',
  },
})
gitment.render('gitment-container')
</script>
</body>
</html>