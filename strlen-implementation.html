<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="zh"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>strlen的实现方法 &mdash; 0xFEE1C001</title>
  <meta name="author" content="Light Xue">
  <meta name="description" content="解析一段牛逼的strlen实现" />

  <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate"
        title="0xFEE1C001 Atom Feed" />





  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="/favicon.png" rel="icon">

  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">0xFEE1C001</a></h1>
    <h2>Where there is a shell, there is a way</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/feeds/atom.xml" rel="subscribe-atom">Atom</a></li>
</ul>


<ul class="main-navigation">
    <li><a href="/">首页</a></li>
    <li><a href="http://tools.lightxue.com">程序员工具</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">strlen的实现方法</h1>
    <p class="meta">
<time datetime="2013-12-07T22:23:46+08:00" pubdate>2013-12-07</time>    </p>
</header>

  <div class="entry-content"><p>感谢<a href="https://plus.google.com/u/0/102034236640204820044">John Smith</a>来稿，笔风太有趣了，能当本博的专栏作家吗？
</p>
<div class="highlight"><pre><span></span>    <span class="kt">size_t</span> <span class="nf">strlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">)</span>
            <span class="n">len</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<p>这大概是通常的写法，或者是像C语言程序设计的示例</p>
<div class="highlight"><pre><span></span>    <span class="kt">int</span> <span class="nf">strlen</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<p>和某B偶然说到这个函数，那B说面试的时候老大问了strlen的写法，他当时用了一种
比较快速的方法。第一反应这货还有快速实现？怎么搞都得遍历完这个字符串，O(n)没跑了，你丫忽悠我。</p>
<p>答曰不是，然后上网去搜了一个glibc的strlen实现。大概如下：</p>
<div class="highlight"><pre><span></span>    <span class="kt">size_t</span> <span class="nf">strlen</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">char_ptr</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="o">*</span><span class="n">longword_ptr</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">longword</span><span class="p">,</span> <span class="n">magic_bits</span><span class="p">,</span> <span class="n">himagic</span><span class="p">,</span> <span class="n">lomagic</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">char_ptr</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span> <span class="n">char_ptr</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">longword</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="o">++</span><span class="n">char_ptr</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">char_ptr</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">char_ptr</span> <span class="o">-</span> <span class="n">str</span><span class="p">;</span>

        <span class="n">longword_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">char_ptr</span><span class="p">;</span>

        <span class="n">magic_bits</span> <span class="o">=</span> <span class="mh">0x7efefeffL</span><span class="p">;</span>
        <span class="n">himagic</span> <span class="o">=</span> <span class="mh">0x80808080L</span><span class="p">;</span>
        <span class="n">lomagic</span> <span class="o">=</span> <span class="mh">0x01010101L</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">longword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">magic_bits</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x7efefefeL</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xfefefeffL</span><span class="p">;</span>
            <span class="n">himagic</span> <span class="o">=</span> <span class="p">((</span><span class="n">himagic</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">himagic</span><span class="p">;</span>
            <span class="n">lomagic</span> <span class="o">=</span> <span class="p">((</span><span class="n">lomagic</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">lomagic</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">longword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">abort</span> <span class="p">();</span>

        <span class="k">for</span> <span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">longword</span> <span class="o">=</span> <span class="o">*</span><span class="n">longword_ptr</span><span class="o">++</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(((</span><span class="n">longword</span> <span class="o">-</span> <span class="n">lomagic</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">himagic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">longword_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">longword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">str</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>艹，这么长(你这么想了，你一定这么想了)。</p>
<p>大概看了下，主要思想是一次取4/8个字节的数据进行判断。减少了将数据从内存搬到寄存器的指令次数。碉堡了，简直碉堡了。</p>
<p>以32位机器为例。</p>
<p>第一步地址4字节对齐。将地址与上<code>0x03</code>，抹掉前面的bits，留下最后两位，检查是否为0，为0则地址是4字节对齐的退出循环，否则地址+1。</p>
<p>第二步4字节作步长，检查取到的4字节中是否有<code>\0</code>，有的话，return 长度，没有继续往后走。检查是否有<code>\0</code>，是通过 <code>(x - 0x01010101L) &amp; 0x80808080L != 0</code>来做的。至于为啥可以这么做，自行列竖式试验下就知道了。如果有<code>\0</code>，遍历那4个字节，看具体是哪个字节是<code>\0</code>。</p>
<p>至此，实现方式已经清楚了。</p>
<p>但是这种方式实际上对于非ascii字符串是有问题的，会误判。所谓步子迈大了容易扯着tama。 unicode，GBK啥的，虽然函数不会出错，但是效率退化到和普通遍历一样了。 GBK是这样编码的好像，比如两字节表示一个字，这种情况下第一个字节肯定是大于等于128。就是说第一个字节最高位是1，这样 <code>(x - 0x01010101L) &amp; 0x80808080L != 0</code>判断是否有<code>\0</code>就失效了，就算上面的判断为true，那4个字节也没有<code>\0</code>，代码会遍历那4个字节，发现实际上没有<code>\0</code>，不退出，继续往后走直到找到<code>\0</code>。</p>
<p>理论上对于ascii字符串，glibc的实现可以达到3X的效率提升，仔细想想 Is it worthwhile?</p>
<p>who knows? ╮(╯_╰)╭, it all depends.</p>
<p>现在的电脑，内存带宽大概在5GB/s(我胡邹的)，<code>mov VAR, %eax</code>这条指令大约消耗十几到几十个时钟周期(这也是胡诌的)。做这样的优化是否有意义不太好说，真是超级无所谓的事情。对程序员来说，就知道大概有这么一种思想，可以这么做，聊以自慰罢了。</p>
<p>----喂喂，你是认真的么</p>
<p>----我错了，我说谎了，最大作用是可以和别人拿来zhuangbility。。。</p>
<p>顺便说一下，CRC32算法也用到这种的思想了(同上)。一次取4字节数据进行计算 + 打表。可以达到原本计算方法几十倍速度的提升吧，大概。。。有兴趣自行wikipedia。</p>
<p>以上</p>
<p>john_smith，2013-12-07，一边听着柿姐的&lt;虎视眈眈&gt;，一边看里番，一边想着中午吃什么，一边写这个。</p>
<p>无所谓，真是超级无所谓的事情。</p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        <a href="/author/john-smith">John Smith</a>
    </span>
  </span>
<time datetime="2013-12-07T22:23:46+08:00" pubdate>2013-12-07</time>  <!--<span class="categories">-->
    <!--<a class='category' href='/category/c'>C</a>-->
  <!--</span>-->
  <!---->
  <!--<span class="categories">-->
    <!---->
    <!--<a class="category" href="/tag/c">C</a>-->
    <!---->
  <!--</span>-->
  <!---->
</p><p class="meta">
本作品由<a xmlns:cc="http://creativecommons.org/ns#" target="_blank" href="http://www.lightxue.com" property="cc:attributionName" rel="cc:attributionURL">www.lightxue.com</a>采用<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/deed.zh">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可。
<p>
<div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>最新文章</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/transforming-code-into-beautiful-idiomatic-python">[译]让你的Python代码优雅又地道</a>
      </li>
      <li class="post">
          <a href="/python-internals-locate-source-code">Python源码寻宝记——地图篇</a>
      </li>
      <li class="post">
          <a href="/python-internals-introductory">Python源码寻宝记——挖坑不埋</a>
      </li>
      <li class="post">
          <a href="/edm-practices-notes">邮件发送实践经验</a>
      </li>
      <li class="post">
          <a href="/how-logrotate-works">logrotate机制和原理</a>
      </li>
    </ul>
  </section>
  <section>

    <h1>分类</h1>
    <ul id="recent_posts">
        <li><a href="/category/c">C</a></li>
        <li><a href="/category/linux">Linux</a></li>
        <li><a href="/category/misc">Misc</a></li>
        <li><a href="/category/python">Python</a></li>
    </ul>
  </section>

  <!--<section>-->
  <!--<h1>Tags</h1>-->
  <!---->
    <!--<a href="/tag/python">Python</a>,-->
  <!---->
    <!--<a href="/tag/linux">Linux</a>,-->
  <!---->
    <!--<a href="/tag/c">C</a>,-->
  <!---->
    <!--<a href="/tag/shell">shell</a>,-->
  <!---->
    <!--<a href="/tag/algorithm">algorithm</a>-->
  <!---->
  <!--</section>-->



</aside>    </div>
  </div>
  <footer role="contentinfo">    Copyright &copy;  2013&ndash;2017  Light Xue &mdash;
  <span class="credit">Powered by <a target="_blank" href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8a9edae11717cd734925510200712026";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  <script type="text/javascript">
    var disqus_shortname = '0xfee1c00l';
    var disqus_identifier = '/strlen-implementation';
    var disqus_url = 'http://www.lightxue.com/strlen-implementation';
    var disqus_title = 'strlen的实现方法';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</body>
</html>